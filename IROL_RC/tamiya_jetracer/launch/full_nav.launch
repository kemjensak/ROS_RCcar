<launch> 
  <arg name="joy_config" default="ps3" />
  <arg name="joy_dev" default="/dev/input/js0" />
  <arg name="config_filepath" default="$(find teleop_twist_joy)/config/$(arg joy_config).config.yaml" />
  <!-- <arg name = "model" default = "$(find tamiya_description)/urdf/tamiya.urdf" /> -->
  <arg name="load_map_file_path" default="$(find tamiya_jetracer)/maps/mymap.yaml"/>

  <rosparam command="load" file="$(find tamiya_jetracer)/cfg/mobile_robot_odometry.yaml" />
  
  <include file="$(find rplidar_ros)/launch/rplidar.launch">
    <param name="serial_port" value="/dev/rplidar"/>
  </include>
  
  <node name="xsens_mti_node" pkg="xsens_mti_driver" type="xsens_mti_node" output="screen">
      <rosparam command="load" file="$(find tamiya_jetracer)/param/xsens_mti_node.yaml" />
  </node>

  <node pkg="tamiya_jetracer" name="vesc_node" type="vesc_controller.py" output="screen"> </node>
  <node pkg="tamiya_jetracer" name="odom_publisher" type="odom_publisher" output="screen"> </node>

  <include file="$(find teleop_twist_joy)/launch/teleop.launch"/>

  <node pkg="tf" type="static_transform_publisher" name="base_to_laser_broadcaster" args="0.25 0 0.155 3.14 0 0 base_link laser 10"/>
  <node pkg="tf" type="static_transform_publisher" name="base_to_imu_broadcaster" args="0.17 0 0.125 0 0 0 base_link imu_link 10"/>

  <node pkg="robot_localization" type="ukf_localization_node" name="ukf_se" clear_params="true">
    <rosparam command="load" file="$(find tamiya_jetracer)/param/ukf_template.yaml" />

     <!-- Placeholder for output topic remapping -->
    <!-- <remap from="odometry/filtered" to="/odom"/> -->
    <!-- <remap from="accel/filtered" to=""/> -->
   

  </node>

    <!-- Run the map server -->
  <node name="map_server" pkg="map_server" type="map_server" args="$(arg load_map_file_path)" >
    <param name="frame_id" value="map"/>
  </node>
                                      

  <!-- <node name="odomtransformer" pkg="tamiya_jetracer" type="odomtransformer.py" output="screen">
		<param name="odom_input" value="/odom" />
		<param name="tf_output" value="/base_link" />
	</node> -->

  <!-- AMCL node -->
  <node pkg="amcl" type="amcl" name="amcl">
    <param name="tf_broadcast" value="true"/>
    <param name="global_frame_id" value="/map"/>

    <!-- Publish scans from best pose at a max of 10 Hz -->
    <param name="odom_model_type" value="diff"/>
    <param name="odom_alpha5" value="0.1"/>
    <param name="transform_tolerance" value="0.2" />
    <param name="gui_publish_rate" value="10.0"/>
    <param name="laser_max_beams" value="30"/>
    <param name="min_particles" value="100"/>
    <param name="max_particles" value="5000"/>
    <param name="kld_err" value="0.05"/>
    <param name="kld_z" value="0.99"/>
    <param name="odom_alpha1" value="0.8"/>
    <param name="odom_alpha2" value="0.8"/>
    <!-- translation std dev, m -->
    <param name="odom_alpha3" value="0.2"/>
    <param name="odom_alpha4" value="0.2"/>
    <param name="laser_z_hit" value="0.9"/>
    <param name="laser_z_short" value="0.05"/>
    <param name="laser_z_max" value="0.05"/>
    <param name="laser_z_rand" value="0.5"/>
    <param name="laser_sigma_hit" value="0.1"/>
    <param name="laser_lambda_short" value="0.1"/>
    <param name="laser_lambda_short" value="0.1"/>
    <param name="laser_model_type" value="likelihood_field"/>
    <!-- <param name="laser_model_type" value="beam"/> -->
    <param name="laser_likelihood_max_dist" value="5.0"/>
    <param name="update_min_d" value="0.05"/>
    <param name="update_min_a" value="0.1"/>
    <param name="odom_frame_id" value="odom"/>
    <param name="resample_interval" value="1"/>
    <param name="recovery_alpha_slow" value="0.0"/>
    <param name="recovery_alpha_fast" value="0.0"/>
    <param name="first_map_only" value="true"/>
    <param name="use_map_topic" value="false"/>
    <param name="initial_pose_x" value="0.0"/>
    <param name="initial_pose_y" value="0.0"/>
    <param name="initial_pose_a" value="-1.57"/>
  </node>
  
    
      

  <node pkg="move_base" type="move_base" respawn="false" name="move_base" output="screen">
    <rosparam file="$(find tamiya_jetracer)/cfg/carlike/costmap_common_params.yaml" command="load" ns="global_costmap" /> 
    <rosparam file="$(find tamiya_jetracer)/cfg/carlike/costmap_common_params.yaml" command="load" ns="local_costmap" />
    <rosparam file="$(find tamiya_jetracer)/cfg/carlike/local_costmap_params.yaml" command="load" />
    <rosparam file="$(find tamiya_jetracer)/cfg/carlike/global_costmap_params.yaml" command="load" /> 
    <!-- <rosparam file="$(find tamiya_jetracer)/base_local_planner_params.yaml" command="load" /> -->
    <!-- <rosparam file="$(find tamiya_jetracer)/dwa_local_planner_params.yaml" command="load" /> -->
    <rosparam file="$(find tamiya_jetracer)/cfg/carlike/teb_local_planner_params.yaml" command="load" /> 

    <rosparam file="$(find tamiya_jetracer)/cfg/move_base_params.yaml" command="load" />
    <rosparam file="$(find tamiya_jetracer)/cfg/global_planner_params.yaml" command="load" />
    <!-- <rosparam file="$(find tamiya_jetracer)/navfn_global_planner_params.yaml" command="load" /> -->

    

    <param name="base_global_planner" value="global_planner/GlobalPlanner" />
    <!-- <param name="DWAPlannerROS/global_frame_id" value="map" /> -->
    <param name="planner_frequency" value="5.0" />
    <param name="planner_patience" value="20.0" />

    <param name="controller_frequency" value="10.0" />
    <param name="controller_patience" value="30.0" />

    <param name="clearing_rotation_allowed" value="false" /> <!-- Our carlike robot is not able to rotate in place -->



  </node>
  
  <node name="rviz" pkg="rviz" type="rviz"/>


</launch>